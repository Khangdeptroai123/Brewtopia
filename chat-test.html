<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Test Chat + ·∫¢nh</title>
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <style>
      body {
        font-family: Arial;
        padding: 20px;
      }
      input,
      textarea {
        width: 100%;
        margin-top: 8px;
      }
      img {
        max-width: 300px;
        margin-top: 5px;
      }
      .message {
        border-bottom: 1px solid #ccc;
        padding: 10px 0;
      }
    </style>
  </head>
  <body>
    <h2>üì® G·ª≠i tin nh·∫Øn v√† ·∫£nh qua Socket.IO</h2>

    <label>Chat Room ID</label>
    <input type="text" id="chatId" value="room123" />

    <label>Sender ID</label>
    <input type="text" id="senderId" value="user123" />

    <label>Tin nh·∫Øn vƒÉn b·∫£n</label>
    <textarea id="message" rows="3"></textarea>
    <button onclick="sendText()">üì§ G·ª≠i Tin nh·∫Øn</button>

    <hr />

    <label>Ch·ªçn ·∫£nh ƒë·ªÉ g·ª≠i</label>
    <input type="file" id="imageInput" />
    <button onclick="uploadAndSendImage()">üì∏ Upload & G·ª≠i ·∫£nh</button>

    <hr />
    <h3>üì• Tin nh·∫Øn nh·∫≠n ƒë∆∞·ª£c:</h3>
    <div id="messages"></div>

    <script>
      const socket = io("http://localhost:4000"); // ‚ö†Ô∏è ƒê·ªïi n·∫øu backend b·∫°n d√πng port kh√°c

      // Nh·∫≠n tin nh·∫Øn text
      socket.on("receiveMessage", (data) => {
        displayMessage(data.sender, data.message);
      });

      // Nh·∫≠n h√¨nh ·∫£nh
      socket.on("chat:receiveImage", (data) => {
        displayImage(data.sender, data.image);
      });

      function displayMessage(sender, text) {
        const msgBox = document.createElement("div");
        msgBox.className = "message";
        msgBox.innerHTML = `<strong>${sender}:</strong> ${text}`;
        document.getElementById("messages").appendChild(msgBox);
      }

      function displayImage(sender, imgUrl) {
        const msgBox = document.createElement("div");
        msgBox.className = "message";
        msgBox.innerHTML = `<strong>${sender} g·ª≠i ·∫£nh:</strong><br><img src="${imgUrl}" />`;
        document.getElementById("messages").appendChild(msgBox);
      }

      function sendText() {
        const chatId = document.getElementById("chatId").value;
        const senderId = document.getElementById("senderId").value;
        const message = document.getElementById("message").value;

        if (!message.trim()) return alert("Nh·∫≠p tin nh·∫Øn!");

        socket.emit("sendMessage", { chatId, senderId, message });
        document.getElementById("message").value = "";
      }

      async function uploadAndSendImage() {
        const chatId = document.getElementById("chatId").value;
        const senderId = document.getElementById("senderId").value;
        const fileInput = document.getElementById("imageInput");

        if (!fileInput.files.length) return alert("Ch·ªçn ·∫£nh!");

        const formData = new FormData();
        formData.append("images", fileInput.files[0]);

        try {
          const res = await fetch(
            "http://localhost:4000/api/chat/upload-image",
            {
              method: "POST",
              body: formData,
            }
          );

          const result = await res.json();

          if (!result.imageUrl) {
            alert("L·ªói upload: " + (result.message || "kh√¥ng c√≥ ·∫£nh URL"));
            return;
          }

          socket.emit("chat:sendImage", {
            chatId,
            senderId,
            imageUrl: result.imageUrl,
          });

          fileInput.value = "";
        } catch (err) {
          alert("L·ªói g·ª≠i ·∫£nh: " + err.message);
        }
      }
    </script>
  </body>
</html>
